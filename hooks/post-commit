#!/bin/bash

# Universal Git Post-Commit Hook
# Works in any repository where Commit Story is locally installed
# Only triggers journal generation if Commit Story is configured for this repo

# Function to log debug messages if debug mode is enabled
debug_log() {
    if [[ -f "commit-story.config.json" ]] && command -v node >/dev/null 2>&1; then
        DEBUG_ENABLED=$(node -e "
            try {
                const config = require('./commit-story.config.json');
                console.log(config.debug || false);
            } catch(e) {
                console.log(false);
            }
        " 2>/dev/null || echo "false")

        if [[ "$DEBUG_ENABLED" == "true" ]]; then
            echo "ðŸª Git Hook: $1" >&2
        fi
    fi
}

# Check if Commit Story is configured for this repository
is_commit_story_enabled() {
    # Must have config file and either local installation or development mode
    [[ -f "commit-story.config.json" ]] && ([[ -f "node_modules/.bin/commit-story" ]] || [[ -f "src/index.js" ]])
}

# Function to check if debug mode is enabled
is_debug_enabled() {
    if [[ -f "commit-story.config.json" ]] && command -v node >/dev/null 2>&1; then
        DEBUG_ENABLED=$(node -e "
            try { 
                const config = require('./commit-story.config.json'); 
                console.log(config.debug || false); 
            } catch(e) { 
                console.log(false); 
            }
        " 2>/dev/null || echo "false")
        
        [[ "$DEBUG_ENABLED" == "true" ]]
    else
        return 1  # Debug disabled if no config or node
    fi
}

# Main execution
debug_log "Commit Story starting"

# Only run if Commit Story is configured for this repository
if is_commit_story_enabled; then
    # Run in foreground if debug mode, background otherwise
    if is_debug_enabled; then
        if [[ -f "node_modules/.bin/commit-story" ]]; then
            ./node_modules/.bin/commit-story HEAD
            EXIT_CODE=$?
        else
            node src/index.js HEAD
            EXIT_CODE=$?
        fi

        # Only show completion message if it succeeded
        if [[ $EXIT_CODE -eq 0 ]]; then
            debug_log "Commit Story completed"
        fi
    else
        if [[ -f "node_modules/.bin/commit-story" ]]; then
            (./node_modules/.bin/commit-story HEAD >/dev/null 2>&1 &)
        else
            (node src/index.js HEAD >/dev/null 2>&1 &)
        fi
    fi
fi

exit 0
